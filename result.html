<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>回答結果</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: 2em auto; }
    table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 8px; text-align: center; }
    th { background:#f6f6f6; }
    .comment { text-align: left; max-width: 300px; white-space: pre-wrap; word-break: break-word; }
    .unanswered { color: #b00; }
  </style>
</head>
<body>
  <h1 id="title">読み込み中...</h1>
  <div id="summary"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCKlrqoZlMhrPKbfqLZS2MvnE5FATH1cBg",
      authDomain: "schedule-app-abbb3.firebaseapp.com",
      databaseURL: "https://schedule-app-abbb3-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "schedule-app-abbb3",
      storageBucket: "schedule-app-abbb3.firebasestorage.app",
      messagingSenderId: "159076358828",
      appId: "1:159076358828:web:57c8daa28f29404b79dd09"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const id = new URLSearchParams(location.search).get("id");

    // URLセーフBase64 -> 日本語
    function decodeKey(str) {
      str = str.replace(/-/g,'+').replace(/_/g,'/');
      while (str.length % 4) str += '=';
      return decodeURIComponent(escape(atob(str)));
    }

    db.ref("events/" + id).once("value")
      .then(snap => {
        const event = snap.val();
        if (!event) {
          document.getElementById("title").textContent = "イベントが見つかりません";
          return;
        }
        document.getElementById("title").textContent = event.name;

        const dates = event.dates || [];

        // answersData: オブジェクトの値一覧（各値は保存時の payload か legacy 形式）
        const answersData = Object.entries(event.answers || {});

        // テーブルヘッダ（コメント列追加）
        const table = document.createElement("table");
        const header = document.createElement("tr");
        header.innerHTML = "<th>名前</th>" + dates.map(d => `<th>${d}</th>`).join("") + "<th>コメント</th>";
        table.appendChild(header);

        // 回答済み名の抽出（payload.name優先、キー decode も試す）
        const answeredNames = answersData.map(([key, val]) => {
          if (val && typeof val === 'object' && val.name) return val.name;
          try { return decodeKey(key); } catch(e) { return key; }
        });

        const unanswered = (event.names || []).filter(n => !answeredNames.includes(n));

        // 各参加者行を作成
        (event.names || []).forEach(name => {
          const row = document.createElement("tr");
          let rowHtml = `<td>${name}</td>`;
          // 見つける: answersData の中から name に一致するレコードを探索
          let record = null;
          for (const [key, val] of answersData) {
            if (val && typeof val === 'object') {
              if (val.name === name) { record = val; break; }
            } else {
              // legacy: val might be an object map of date->answer
              try {
                const decoded = decodeKey(key);
                if (decoded === name) { record = val; break; }
              } catch(e) { /* ignore */ }
            }
          }

          // 日付セルの決定（record は payload or legacy）
          dates.forEach(d => {
            let cell = "-";
            if (record) {
              if (Array.isArray(record.answers)) {
                const found = record.answers.find(x => x.date === d);
                cell = found ? found.answer : "-";
              } else if (typeof record === 'object' && !Array.isArray(record)) {
                // legacy: record might be { "8/23":"◯", ... } OR payload-like object
                if (record[d]) cell = record[d];
                else if (record.answers && record.answers[d]) cell = record.answers[d];
                else if (record.hasOwnProperty(d)) cell = record[d];
              }
            }
            rowHtml += `<td>${cell}</td>`;
          });

          // コメント取得（payload.comment があれば表示）
          let commentText = "";
          if (record && typeof record === 'object') {
            if (record.comment) commentText = record.comment;
            else if (record.comments) commentText = record.comments;
          }
          rowHtml += `<td class="comment">${commentText || "-"}</td>`;
          row.innerHTML = rowHtml;
          table.appendChild(row);
        });

        document.getElementById("summary").appendChild(table);

        if (unanswered.length) {
          const p = document.createElement("p");
          p.innerHTML = `<strong class="unanswered">未回答:</strong> ${unanswered.join('、')}`;
          document.getElementById("summary").appendChild(p);
        }
      })
      .catch(err => {
        console.error("読み込み失敗:", err);
        document.getElementById("title").textContent = "読み込みエラー（コンソール参照）";
      });
  </script>
</body>
</html>
