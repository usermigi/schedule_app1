<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>回答結果</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: 2em auto; }
    table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 8px; text-align: center; }
    th { background:#f6f6f6; }
    .unanswered { color: #b00; }
  </style>
</head>
<body>
  <h1 id="title">読み込み中...</h1>
  <div id="summary"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCKlrqoZlMhrPKbfqLZS2MvnE5FATH1cBg",
      authDomain: "schedule-app-abbb3.firebaseapp.com",
      databaseURL: "https://schedule-app-abbb3-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "schedule-app-abbb3",
      storageBucket: "schedule-app-abbb3.firebasestorage.app",
      messagingSenderId: "159076358828",
      appId: "1:159076358828:web:57c8daa28f29404b79dd09"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const id = new URLSearchParams(location.search).get("id");

    // decodeKey: URLセーフBase64 -> 日本語
    function decodeKey(str) {
      str = str.replace(/-/g,'+').replace(/_/g,'/');
      while (str.length % 4) str += '=';
      return decodeURIComponent(escape(atob(str)));
    }

    db.ref("events/" + id).once("value")
      .then(snap => {
        const event = snap.val();
        if (!event) {
          document.getElementById("title").textContent = "イベントが見つかりません";
          return;
        }
        document.getElementById("title").textContent = event.name;

        const dates = event.dates || [];
        // answersData: 配列化された値（各キーの value は {name, answers: [...] }）
        const answersData = Object.values(event.answers || {});

        // header
        const table = document.createElement("table");
        const header = document.createElement("tr");
        header.innerHTML = "<th>名前</th>" + dates.map(d => `<th>${d}</th>`).join("");
        table.appendChild(header);

        // 回答者一覧（event.names の順で表示）
        const answeredNames = answersData.map(a => a.name);
        const unanswered = (event.names || []).filter(n => !answeredNames.includes(n));

        (event.names || []).forEach(name => {
          const row = document.createElement("tr");
          row.innerHTML = `<td>${name}</td>`;
          const answerObj = answersData.find(a => a.name === name);
          dates.forEach(date => {
            const ans = answerObj?.answers?.find(x => x.date === date)?.answer || "-";
            row.innerHTML += `<td>${ans}</td>`;
          });
          table.appendChild(row);
        });

        document.getElementById("summary").appendChild(table);

        if (unanswered.length) {
          const p = document.createElement("p");
          p.innerHTML = `<strong class="unanswered">未回答:</strong> ${unanswered.join('、')}`;
          document.getElementById("summary").appendChild(p);
        }
      })
      .catch(err => {
        console.error("読み込み失敗:", err);
        document.getElementById("title").textContent = "読み込みエラー（コンソール参照）";
      });
  </script>
</body>
</html>
